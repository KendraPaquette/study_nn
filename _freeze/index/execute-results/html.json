{
  "hash": "03400cc7dfd862930dcde095e85fd846",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Adaptive EMA Sampling for Alcohol Lapse Risk Prediction - A Reinforcement Learning Approach\nauthor:\n  - name: Jeongyeol Kwon \n    corresponding: false\n    affiliations:\n      - Department of X, University of Wisconsin-Madison\n  - name: Kendra Wyant \n    corresponding: false\n    affiliations:\n      - Department of Psychology, University of Wisconsin-Madison\n  - name: John J. Curtin \n    corresponding: true\n    email: jjcurtin@wisc.edu\n    affiliations:\n      - Department of Psychology, University of Wisconsin-Madison \nkeywords:\n  - Substance use disorders\n  - Precision mental health \nabstract: |\n  Abstract here.\ndate: last-modified\nbibliography: references.bib\nnumber-sections: false \neditor_options: \n  chunk_output_type: console\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# load libraries and read in data for printing results\n\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nhere() starts at C:/Users/kpaquette2/study_nn\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ntheme_set(theme_classic())\n\naucs <- read_csv(here(\"data/auc_3_x_10.csv\"),\n                 show_col_types = FALSE)\nposteriors <- read_csv(here(\"data/posteriors.csv\"),\n                       show_col_types = FALSE)\npp_tibble <- read_csv(here(\"data/pp_perf_tibble.csv\"),\n                       show_col_types = FALSE) |> \n  mutate(model = factor(model, \n                        levels = c(\"xgboost\", \"nn_full\", \"nn_lv1\", \n                                   \"nn_lv2\", \"nn_lv3\", \"nn_lv4\"),\n                        labels = c(\"xgboost\", \"no penalty\", \"Lv1\", \n                                   \"Lv2\", \"Lv3\", \"Lv4\"))) \ncontrasts <- read_csv(here(\"data/contrast.csv\"),\n                      show_col_types = FALSE)\nfreq <- read_csv(here(\"data/freq.csv\"),\n                      show_col_types = FALSE) |> \n  mutate(model = factor(model, \n                        levels = c(\"full\", \"lv1\", \n                                   \"lv2\", \"lv3\", \"lv4\"),\n                        labels = c(\"no penalty\", \"Lv1\", \n                                   \"Lv2\", \"Lv3\", \"Lv4\")))\nlapses <- read_csv(here(\"data/lapses.csv\"),\n                      show_col_types = FALSE)\n```\n:::\n\n\n\n\n\n\n\n\n# Introduction\n\nPersonal sensing is the collection and analyses of data collected via smartphone and other digital devices in the context of one's day-to-day life [@mohrPersonalSensingUnderstanding2017]. \n\nPersonal sensing data can be used as inputs into machine learning algorithms to predict important clinical psychological outcomes. Existing literature suggests behavior (substance use [@wyantMachineLearningModels2024; @wyantLaggedPredictionsNextinprep; @baeMobilePhoneSensors2018; @waltersUsingMachineLearning2021; @robertsUsingMachineLearning2022; @baeLeveragingMobilePhone2023; @soysterPooledPersonspecificMachine2022]), mood (depression [@jacobsonPassiveSensingPrediction2020; @kimDepressionPredictionUsing2019; @razaviDepressionScreeningUsing2020]; anxiety [@jacobsonDigitalBiomarkersAnxiety2022]), cognitive processes (craving [@epsteinPredictionStressDrug2020; @dumortierClassifyingSmokingUrges2016]; suicidal thoughts [@czyzPredictingShorttermSuicidal2023]), and even future mental health diagnoses (@horwitzIntensiveLongitudinalAssessment2024) can be predicted with high accuracy and temporal precision from personal sensing data. \n\nMany mental health disorders, like substance use disorders, depression, and anxiety, are chronic conditions. After initial treatment and symptom reduction, individuals must continue to monitor their symptoms indefinitely. \n\nMachine learning models can help individuals self-monitor changes in their risk for symptom-relapse and provide information about intervenable targets for lowering their risk (e.g., urge surfing for strong craving, behavioral activation for low motivation, and mindful breathing for acute and distressing physiological arousal).\n\nThe existing successful prediction models have almost exclusively relied on ecological momentary assessment (EMA) as the primary personal sensing data collection method. EMA consists of daily or more frequent brief self-report surveys pushed to an individual's smartphone (i.e., prompts).\n\nEMA offers insight into feelings, thoughts and behaviors. As such it is not surprising that it has been demonstrated to be highly predictive of clinical psychological outcomes. \n\nEMA items are also often easily mapped on to support recommendations and targets for interventions. For example, the relapse prevention literature for substance use provides extant evidence-based recommendations for coping with strong cravings, stressful situations, and risky situations [@marlattRelapsePreventionSecond2007; @witkiewitzTherapistsGuideEvidenceBased2007].\n\nEMA models that predict substance use with high temporal precision (i.e., alcohol use in the next 1-24 hours) have relied on densely sampled EMA (4-8x daily [@wyantMachineLearningModels2024; @wyantLaggedPredictionsNextinprep; @waltersUsingMachineLearning2021; @soysterPooledPersonspecificMachine2022]). While it appears frequent EMA sampling can be sustainable for discrete sampling periods (e.g. 1-3 months) [@wyantAcceptabilityPersonalSensing2023; @jonesComplianceEcologicalMomentary2019], it is less clear whether such sampling rates can be maintained indefinitely. Some evidence suggests individuals with substance use disorders can maintain 1x daily EMA for up to 1 year [@moshontzProspectivePredictionLapses2021]. Still, recovery is dynamic and often lifelong. \n\n@wyantMachineLearningModels2024 have developed a machine learning model using 4x daily EMA that can predict alcohol lapses occurring in the next 24 hours with high accuracy (.90 area under the ROC curve [auROC]). This model can be used to provide personalized support recommendations to address immediate risks for possible lapses. For example, the model can be updated each day to provide individuals information about changes in their risk and make supportive recommendations based on the top features contributing to their risk.\n\nWhile this model suggests promising clinical utility, frequent prompts each day could become burdensome. Engagement with the sensing method could drop leading to sparse feature sets. Similarly, individuals could become bored with the repetitive nature of questions, increasing the likelihood of careless or automatic responding without reflection.\n\nRecognizing these limitations, we seek to apply a precision medicine approach to EMA sampling where individuals are only prompted to complete an EMA when the information is needed to maintain accurate lapse predictions. \n\nSpecifically we ran a stimulation study that…\n\n\n\n\n\n# Methods\n\n## Data Analytic Strategy\n\nModels were run on an NVIDIA GeForce RTX 3090. <!--lets talk about what this is and if its important to include. If we keep it maybe add a sentence about why it was important to the analyses.-->\n\n<!--Should we include a sentence saying models were trained and evaluated using Python (Version #) and list any major packages used?-->\n\n### Model Architecture\n\nWe formulate the survey design problem as offline reinforcement learning (RL). Specifically, we model the interaction with each participant as an episode. Our goal is to design a survey plan that maximizes the expected cumulative rewards (and minimize penalties) over all participants during the entire episodes. That is, we consider each participant as a new environment instantiated out of $N$ environments; each environment is simulated based on the offline survey data collected in.\n\nIn each episode with a participant, at each $t^{th}$ time-step, we either ask (1) whether or not to reveal the survey, or (2) to predict the next 24-hour window lapse. When we get the next survey $X_t$ from the participant (the former), we choose a binary action at deciding whether to reveal the survey or not; that is, we do not observe the survey ot = 0 without penalty if at = 0, and observe the received survey ot = Xt if at = 1, with a penalty depending on penalty levels. This penalty level is a control factor that balances the survey frequency and the prediction accuracy. If the environment asks to predict the next 24-hour window lapse event yt (the latter), an agent does not get any observation, only getting a hidden reward/penalty depending on whether the prediction is correct. <!--finish updating math syntax - see https://qmd4sci.njtierney.com/math.html-->\n\nMore specifically, our training pipeline can be described as consisting of three networks (summarizer network, policy network, prediction network; @fig-method).\n\n\n\n\n::: {#cell-fig-method .cell}\n\n```{.r .cell-code .hidden}\nknitr::include_graphics(path = here::here(\"figures/methods.png\"), error = FALSE)\n```\n\n::: {.cell-output-display}\n![Architecture for two-phase training.](figures/methods.png){#fig-method width=211}\n:::\n:::\n\n\n\n\n#### 1. Summarizer Network\n\n<!--I'm not sure what a summarizer network is. Maybe explain it in a few sentences.-->\nOur default configuration employs transformer architectures for the summarizing model. For implementing the transformer model, we adhere to the minimal implementation of NanoGPT’s standard framework1. We use an Embedding layer for discrete actions. For the policy network, we employ the soft actor-critic method for discrete actions (SACD). We use the base two-layer fully-connected architecture for both actor and critic networks. The lapse prediction network uses a single Gated Recurrent Unit (GRU) network. <!--Move this to prediction network section?-->\n\n#### 2. Policy Network\n\nIn this phase, the goal is to learn a survey policy that maximizes the cumulative returns – the sum of all rewards and penalties – averaged over all participants. The policy takes all 25 k-step previous observations, which we call a historical context or simply history, and decides an action to take. We let k = 25 in our experiments. \n\nNew trajectories are generated with φ and the current policy π, which takes a summary statistics φ(ht) as an input and outputs the next action. π is updated to maximize the long-term returns of the system. <!--update math notation-->\n\n<!--Does this make sense to put here?--> We considered four penalty levels (LV) that penalized the model for each survey observation shown: -.02, -.05, -.08, and -.12. Models also learned from penalties and rewards related to the accuracy of their predicted lapses. Models were rewarded .05 or .03 for correctly labeling a lapse or no lapse, respectively. Models were penalized -.2 or -1.2 for incorrectly labeling a lapse or no lapse, respectively. <!--How did you arrive at these reward/penalty values? Were they randomly selected?-->\n\n<!--Add Partially Observed Markov Decision Processes and Objective Formulation and Algorithm 1 here?-->\n\n#### 3. Prediction Network\n\nPredictions were made into 24-hour windows (i.e., the probability of a lapse in the next 24 hours). The first prediction window for each participant started 24 hours from midnight on their study start date. Subsequent prediction window start times for each participant repeatedly rolled forward hour-by-hour until the end of their study participation.\n\nThe start and end date/time of past drinking episodes were reported on the first EMA item. A prediction window was labeled lapse if the start date/hour of any drinking episode fell within that window. A window was labeled no lapse if no alcohol use occurred within that window +/- 24 hours. If no alcohol use occurred within the window but did occur within 24 hours of the start or end of the window, the window was excluded. We ended up with a total of 274,179 labels.\n\nWe used 3 repeats of 10-fold cross-validation to evaluate our models with auROC. auROC indexes the probability that the model will predict a higher score for a randomly selected positive case (lapse) relative to a randomly selected negative case (no lapse). We used grouped cross-validation to assign all data from a participant as either held-in or held-out to avoid bias introduced when predicting a participant’s data from their own data. \n\nThe truncated k-step history ht = (ot−k, at−k, ..., ot) is input into the history summarization model φ(·), yielding summary statistics φ(ht). Then, this summary statistics is fed into the prediction network to predict the next lapse label. The sequence model φ is updated to minimize the prediction loss in this phase. <!--Need to update mathematical notation-->\n\n### Model Evaluation\n\n#### Bayesian Model\n\nWe used a Bayesian hierarchical generalized linear model to estimate the posterior probability distributions and 95% Bayesian credible intervals (CIs) from the 30 held-out test sets for our five best models (no penalty, Lv1, Lv2, Lv3, and Lv4). We used the default weakly informative priors. We set two random intercepts to account for our resampling method: one for the repeat, and another for the fold nested within repeat.  \n\nFrom the Bayesian model we obtained the posterior distribution (transformed back from logit) and Bayeisan CIs for auROCs all five models. To evaluate our models’ overall performance we report the median posterior probability for auROC and Bayesian CIs. This represents our best estimate for the magnitude of the auROC parameter for each model. \n\nWe then conducted Bayesian model comparisons to determine the probability that the penalized models’ performances differed systematically from the baseline (no penalty) model. We also report the precise posterior probability for the difference in auROCs and the 95% Bayesian CIs for these comparisons.\n\n## Results\n\n### Participants\n*Kendra will characterize sample of participants here*\n\n### EMA Adherence and Sampling Frequency\nParticipants on average completed 3.1 (SD=0.6) of the 4 EMAs each day (78.4% adherence overall). Across the twelve weeks on study, EMA adherence ranged from 75.3% to 86.8%. \n\nThe baseline (no penalty) model used all available EMA observations for all participants (proportion of EMAs used = 1.0). As penalties for revealing an EMA observation became higher, overall sampling frequency for EMA observations decreased. The median proportion of EMAs used in the penalized models were .41 (range = .24 - .56), .24 (range = .16 - .34), .12 (range .03 - .20), and .04 (range = 0 - .10) for Lv1, Lv2, Lv3, and Lv4 respectively. \n\nFigure @fig-ema presents histograms that display the distribution of the proportion of EMA observations revealed for each participant. \n\n<!-- note these plots depict 3 proportions for each subid - 1 for each repeat-->\n\n\n\n::: {#cell-fig-ema .cell}\n\n```{.r .cell-code .hidden}\nfreq |> \n  filter(model != \"no penalty\") |> \n  ggplot(aes(x = prop)) +\n  geom_histogram(color = \"black\", fill = \"light grey\", bins = 40) +\n  facet_wrap(~model) +\n  geom_vline(aes(xintercept = med), freq |> \n               filter(model != \"no penalty\") |> \n               group_by(model) |> \n               mutate(med = median(prop))) +\n  labs(title = \"Histogram of proportion of surveys used by subid for each penalty\",\n       x = \"proportion of EMA observations revealed\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fig-ema-1.png){#fig-ema width=672}\n:::\n:::\n\n\n\n\nThere doesn't appear to be a relationship between lapse and proportion of EMA surveys revealed.\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfreq |>\n  filter(model != \"no penalty\") |> \n  left_join(lapses, by = \"subid\") |> \n  ggplot(aes(x = prop, y = prop_lapse_days), alpha = .8) +\n  geom_point() +\n  facet_wrap(~model) +\n  labs(title = \"Relationship between lapses and survey frequency\",\n       x = \"proportion of EMA surveys revealed\",\n       y = \"proportion of study days with lapses\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n### Model Evaluation\n\nRaw median auROCs for xgboost and five neural net models are presented below.\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\naucs |> \n  group_by(n_repeat) |> \n  summarise(across(xgboost:nn_lv4, ~median(.x))) |> \n  ungroup() |> \n  summarise(across(xgboost:nn_lv4, ~median(.x))) |> \n  glimpse() \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1\nColumns: 6\n$ xgboost <dbl> 0.895\n$ nn_full <dbl> 0.88\n$ nn_lv1  <dbl> 0.87\n$ nn_lv2  <dbl> 0.855\n$ nn_lv3  <dbl> 0.835\n$ nn_lv4  <dbl> 0.775\n```\n\n\n:::\n:::\n\n\n\n\n\nMedian posterior probabilities and 95% Bayesian credible intervals for auROC for the XGBoost and 5 neural network models are presented in the table below.\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npp_tibble |> \n  kableExtra::kbl(digits = 3)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> model </th>\n   <th style=\"text-align:right;\"> pp_median </th>\n   <th style=\"text-align:right;\"> pp_lower </th>\n   <th style=\"text-align:right;\"> pp_upper </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> xgboost </td>\n   <td style=\"text-align:right;\"> 0.884 </td>\n   <td style=\"text-align:right;\"> 0.863 </td>\n   <td style=\"text-align:right;\"> 0.902 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> no penalty </td>\n   <td style=\"text-align:right;\"> 0.867 </td>\n   <td style=\"text-align:right;\"> 0.843 </td>\n   <td style=\"text-align:right;\"> 0.887 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Lv1 </td>\n   <td style=\"text-align:right;\"> 0.865 </td>\n   <td style=\"text-align:right;\"> 0.840 </td>\n   <td style=\"text-align:right;\"> 0.886 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Lv2 </td>\n   <td style=\"text-align:right;\"> 0.856 </td>\n   <td style=\"text-align:right;\"> 0.831 </td>\n   <td style=\"text-align:right;\"> 0.878 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Lv3 </td>\n   <td style=\"text-align:right;\"> 0.832 </td>\n   <td style=\"text-align:right;\"> 0.803 </td>\n   <td style=\"text-align:right;\"> 0.856 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Lv4 </td>\n   <td style=\"text-align:right;\"> 0.776 </td>\n   <td style=\"text-align:right;\"> 0.739 </td>\n   <td style=\"text-align:right;\"> 0.806 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n\nPotential main figure\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npp_tibble |> \n  filter(model != \"xgboost\") |> \n  mutate(penalty = c(0, .02, .05, .08, .12)) |> \n  ggplot(aes(x = penalty, y = pp_median)) +\n  geom_point(aes(color = model), size = 2) +\n  geom_segment(mapping = aes(x = penalty, y = pp_lower, yend = pp_upper,\n                             color = model), linewidth = .75) +\n  scale_y_continuous(\"area under ROC curve\", limits = c(.5, 1)) +\n  scale_x_continuous(\"penalty for revealed EMA\", \n                     breaks = c(0, .02, .04, .06, .08, .10, .12)) +\n  scale_color_viridis_d(option = \"D\") +\n  labs(color = NULL) +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n\nHistograms of posterior probabilities for auROC for the 5 neural network models are presented below.  \n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nposteriors |> \n  mutate(model = factor(model, \n                        levels = c(\"nn_full\", \"nn_lv1\", \"nn_lv2\", \n                                   \"nn_lv3\", \"nn_lv4\"),\n                        labels = c(\"no penalty\", \"Lv1\", \"Lv2\", \n                                   \"Lv3\", \"Lv4\"))) |>\n  filter(model != \"xgboost\") |> \n  ggplot() + \n  geom_histogram(aes(x = posterior), fill = \"light grey\", color = \"black\", \n                 bins = 30) +\n  geom_segment(mapping = aes(y = 3000, yend = 3600, x = pp_median, \n                             xend = pp_median),\n               data = subset(pp_tibble, model != \"xgboost\")) +\n  geom_segment(mapping = aes(y = 3400, yend = 3400, x = pp_lower, xend = pp_upper),\n                data = subset(pp_tibble, model != \"xgboost\")) +\n  facet_wrap(~model, ncol = 1) +\n  ylab(\"Posterior Probability Frequency\") +\n  xlab(\"Area Under ROC Curve\") +\n  theme_classic() \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\n\n### Model Comparisons\n\n*Kendra will add a description of the model comparisons below once I see how we are referring to the different models. Essentially these comparisons suggest that we can go down to using about 40% of surveys (LV1) without any difference in model performance. It appears that the model does perform differently when going down to 25% of surveys (LV2) but this is not likely a clinically meaningful drop in performance. LV3 performs worse than LV1, but again it is not likely a clinically meaningful drop.*\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ncontrasts |> \n  kableExtra::kbl(digits = 3)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> contrast </th>\n   <th style=\"text-align:right;\"> probability </th>\n   <th style=\"text-align:right;\"> mean </th>\n   <th style=\"text-align:right;\"> lower </th>\n   <th style=\"text-align:right;\"> upper </th>\n   <th style=\"text-align:right;\"> median </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> nn_full vs. nn_lv1 </td>\n   <td style=\"text-align:right;\"> 0.666 </td>\n   <td style=\"text-align:right;\"> 0.002 </td>\n   <td style=\"text-align:right;\"> -0.006 </td>\n   <td style=\"text-align:right;\"> 0.011 </td>\n   <td style=\"text-align:right;\"> 0.002 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> nn_full vs. nn_lv2 </td>\n   <td style=\"text-align:right;\"> 0.977 </td>\n   <td style=\"text-align:right;\"> 0.011 </td>\n   <td style=\"text-align:right;\"> 0.002 </td>\n   <td style=\"text-align:right;\"> 0.019 </td>\n   <td style=\"text-align:right;\"> 0.011 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> nn_full vs. nn_lv3 </td>\n   <td style=\"text-align:right;\"> 1.000 </td>\n   <td style=\"text-align:right;\"> 0.035 </td>\n   <td style=\"text-align:right;\"> 0.025 </td>\n   <td style=\"text-align:right;\"> 0.045 </td>\n   <td style=\"text-align:right;\"> 0.035 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> nn_full vs. nn_lv4 </td>\n   <td style=\"text-align:right;\"> 1.000 </td>\n   <td style=\"text-align:right;\"> 0.091 </td>\n   <td style=\"text-align:right;\"> 0.078 </td>\n   <td style=\"text-align:right;\"> 0.105 </td>\n   <td style=\"text-align:right;\"> 0.091 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}